@{
    ViewData["Title"] = "Palliative Scale";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" />
<link rel="stylesheet" href="~/css/pps.css" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>

<div class="pps-page">
    <header class="pps-header">
        <h1>Palliative Performance Scale</h1>
        <p>Use this tool to recognize functional decline quickly and inform decisions about your patient's eligibility.</p>
    </header>

    <div class="pps-container">
        <div class="custom-select">
            <div class="select-head" id="selectHead">Choose a Diagnosis <span class="caret">▾</span></div>
            <ul class="select-list" id="selectList"></ul>
        </div>

        <input type="hidden" id="diagnosis" />

        <div class="pps-block">
            <label class="label-head">Ambulation</label>
            <div class="msg-text" id="ambMsg">Slide to see PPS Rating</div>
            <div class="slider-row">
                <div id="ambSlider" class="slider-el"></div>
                <span class="slider-value" id="ambValue">0</span>
            </div>
        </div>

        <div class="pps-block">
            <label class="label-head">Activity</label>
            <div class="msg-text" id="actMsg">Slide to see PPS Rating</div>
            <div class="slider-row">
                <div id="actSlider" class="slider-el"></div>
                <span class="slider-value" id="actValue">0</span>
            </div>
        </div>

        <div class="pps-block">
            <label class="label-head">Evidence of Disease</label>
            <div class="msg-text" id="eviMsg">Slide to see PPS Rating</div>
            <div class="slider-row">
                <div id="eviSlider" class="slider-el"></div>
                <span class="slider-value" id="eviValue">0</span>
            </div>
        </div>

        <div class="pps-block">
            <label class="label-head">Self Care</label>
            <div class="msg-text" id="selfMsg">Slide to see PPS Rating</div>
            <div class="slider-row">
                <div id="selfSlider" class="slider-el"></div>
                <span class="slider-value" id="selfValue">0</span>
            </div>
        </div>

        <div class="pps-block">
            <label class="label-head">Intake</label>
            <div class="msg-text" id="intakeMsg">Slide to see PPS Rating</div>
            <div class="slider-row">
                <div id="intakeSlider" class="slider-el"></div>
                <span class="slider-value" id="intakeValue">0</span>
            </div>
        </div>

        <div class="pps-block">
            <label class="label-head">Level of Consciousness</label>
            <div class="msg-text" id="conMsg">Slide to see PPS Rating</div>
            <div class="slider-row">
                <div id="conSlider" class="slider-el"></div>
                <span class="slider-value" id="conValue">0</span>
            </div>
        </div>

        <div class="footer">
            <button id="calcSave" class="calc-btn">CALCULATE</button>
        </div>

        <button id="calc" style="display:none"></button>
        <button id="save" style="display:none"></button>
    </div>
</div>

<div id="customAlert" class="custom-alert" style="display:none">
    <span id="alertMessage"></span>
    <span id="closeAlert" class="close-x">×</span>
</div>




<script>
    function showAlert(msg){ $("#alertMessage").text(msg); $("#customAlert").show() }
    $(document).on("click","#closeAlert",function(){ $("#customAlert").hide() })

    $(function(){

        const items=[
            {name:"Choose a Diagnosis", color:"#fff3dd"},
            {name:"ALS", color:"#0096FF"},
            {name:"Alzheimer's", color:"#00A3A3"},
            {name:"Cancer", color:"#2FAF8B"},
            {name:"Heart Disease", color:"#C21A2B"},
            {name:"HIV and AIDS", color:"#FF6B8A"},
            {name:"Liver Disease", color:"#F2C04A"},
            {name:"Lung Disease", color:"#FF9AA2"},
            {name:"Renal Disease", color:"#4F5F77"},
            {name:"Sepsis", color:"#884EA0"}
        ];

        items.forEach(i=>{
            $("#selectList").append(`<li data-val="${i.name}"><span class="dot" style="background:${i.color}"></span><span class="label-text">${i.name}</span></li>`)
        });

        $("#selectHead").on("click",function(){ $("#selectList").toggle() });

        $(".slider-el").addClass("slider-disabled");

        $(document).on("click","#selectList li",function(){
            const v=$(this).data("val");
            $("#diagnosis").val(v);
            $("#selectHead").html(v + ' <span class="caret">▾</span>');
            $("#selectList").hide();
            $(".slider-el").removeClass("slider-disabled");
        });

        function createSlider(elId){
            let el=document.getElementById(elId);
            noUiSlider.create(el,{
                start:0,
                step:10,
                range:{min:0,max:100},
                connect:true,
                pips:{mode:'steps',density:10}
            });
            return el.noUiSlider;
        }

        const amb = createSlider("ambSlider");
        const act = createSlider("actSlider");
        const evi = createSlider("eviSlider");
        const self = createSlider("selfSlider");
        const intake = createSlider("intakeSlider");
        const con = createSlider("conSlider");

        amb.on("update",v=>{ let x=parseInt(v[0]); $("#ambValue").text(x); $("#ambMsg").text({0:"Slide to see PPS Rating",10:"Totally bed bound",20:"Totally bed bound",30:"Totally bed bound",40:"Mainly in bed",50:"Mainly sit/lie",60:"Reduced",70:"Reduced",80:"Full",90:"Full",100:"Full"}[x]) })
        act.on("update",v=>{ let x=parseInt(v[0]); $("#actValue").text(x); $("#actMsg").text({0:"Slide to see PPS Rating",10:"Unable to do any activity",20:"Unable to do any",30:"Unable to do any",40:"Unable to do most",50:"Unable to work",60:"Unable to do house/hobby work",70:"Unable normal",80:"Normal with effort",90:"Normal",100:"Normal"}[x]) })
        evi.on("update",v=>{ let x=parseInt(v[0]); $("#eviValue").text(x); $("#eviMsg").text({0:"Slide to see PPS Rating",10:"Extensive disease",20:"Extensive disease",30:"Extensive disease",40:"Extensive disease",50:"Extensive disease",60:"Significant disease",70:"Significant disease",80:"Some evidence",90:"Some evidence",100:"No evidence"}[x]) })
        self.on("update",v=>{ let x=parseInt(v[0]); $("#selfValue").text(x); $("#selfMsg").text({0:"Slide to see PPS Rating",10:"Total care",20:"Total care",30:"Total care",40:"Main assistance",50:"Considerable assistance",60:"Occasional assistance",70:"Full",80:"Full",90:"Full",100:"Full"}[x]) })
        intake.on("update",v=>{ let x=parseInt(v[0]); $("#intakeValue").text(x); $("#intakeMsg").text({0:"Slide to see PPS Rating",10:"Mouth care only",20:"Minimal sips",30:"Normal or reduced",40:"Normal or reduced",50:"Normal or reduced",60:"Normal or reduced",70:"Normal or reduced",80:"Normal or reduced",90:"Normal",100:"Normal"}[x]) })
        con.on("update",v=>{ let x=parseInt(v[0]); $("#conValue").text(x); $("#conMsg").text({0:"Slide to see PPS Rating",10:"Drowsy/coma",20:"Full/drowsy",30:"Full/drowsy",40:"Full/drowsy",50:"Full/confusion",60:"Full/confusion",70:"Full",80:"Full",90:"Full",100:"Full"}[x]) })

        $("#calcSave").on("click",function(){
            let diag=$("#diagnosis").val();
            if(!diag || diag==="Choose a Diagnosis"){ showAlert("Select a Diagnosis First"); return }
            let vals=[parseInt($("#ambValue").text()),parseInt($("#actValue").text()),parseInt($("#eviValue").text()),parseInt($("#selfValue").text()),parseInt($("#intakeValue").text()),parseInt($("#conValue").text())];
            if(vals.includes(0)){ showAlert("Slide All Activities to View PPS Rating"); return }
            let score=Math.round(vals.reduce((a,b)=>a+b,0)/6);
            let msg = score <= 10 ? `PPS Rating ~ ${score}%. Very severe decline.` :
                      score <= 30 ? `PPS Rating ~ ${score}%. Completely bed bound.` :
                      score <= 50 ? `PPS Rating ~ ${score}%. Significant reduction.` :
                      score <= 70 ? `PPS Rating ~ ${score}%. Moderate decline.` :
                      score <= 90 ? `PPS Rating ~ ${score}%. Normal with effort.` :
                      `PPS Rating ~ ${score}%. High function.`;
            showAlert(msg);
            setTimeout(()=>{
                const data = {
                    Diagnosis: diag,
                    Ambulation: vals[0],
                    Activity: vals[1],
                    Evidence: vals[2],
                    SelfCare: vals[3],
                    Intake: vals[4],
                    Consciousness: vals[5],
                    FinalScore: score
                };
                $.ajax({ url:"/Pps/SaveResult", type:"POST", contentType:"application/json", data:JSON.stringify(data), xhrFields:{withCredentials:true} });
            }, 600);
        });

    });
</script>
